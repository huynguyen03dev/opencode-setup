#!/usr/bin/env python3

"""
Sequential Thinking CLI Wrapper
Provides a drop-in replacement for the MCP sequential-thinking tool
"""

import sys
import json
from api import SequentialThinkingEngine


def print_usage():
    """Print CLI usage help"""
    print("""
Sequential Thinking CLI - Drop-in replacement for MCP sequential-thinking

Usage: python3 sequential-thinking <command>

Commands:
  interactive    Start interactive reasoning session
  api           API mode (JSON input/output)
  test          Run test examples

Examples:
  # Interactive mode
  python3 sequential-thinking interactive

  # API mode (compatible with original MCP tool)
  echo '{"thought":"Need to analyze the problem","thoughtNumber":1,"totalThoughts":5,"nextThoughtNeeded":true}' | python3 sequential-thinking api

  # Test with examples
  python3 sequential-thinking test
""")


def run_test():
    """Execute test suite"""
    engine = SequentialThinkingEngine()

    test_cases = [
        {
            'name': 'Initial Thought',
            'params': {
                'thought': 'I need to analyze the database performance issue. The queries are running slowly.',
                'thoughtNumber': 1,
                'totalThoughts': 5,
                'nextThoughtNeeded': True
            }
        },
        {
            'name': 'Follow-up Thought',
            'params': {
                'thought': 'Let me examine the query execution plans to identify bottlenecks.',
                'thoughtNumber': 2,
                'totalThoughts': 5,
                'nextThoughtNeeded': True
            }
        },
        {
            'name': 'Revision Thought',
            'params': {
                'thought': 'After examining the execution plans, I found missing indexes are the primary cause.',
                'thoughtNumber': 3,
                'totalThoughts': 5,
                'isRevision': True,
                'revisesThought': 2,
                'nextThoughtNeeded': True
            }
        },
        {
            'name': 'Final Thought',
            'params': {
                'thought': 'The solution is to add composite indexes on frequently queried columns.',
                'thoughtNumber': 4,
                'totalThoughts': 4,
                'nextThoughtNeeded': False
            }
        }
    ]

    print('üß™ Running Sequential Thinking Tests\n')

    for index, test_case in enumerate(test_cases, 1):
        print(f'Test {index}: {test_case["name"]}')
        print('‚îÄ' * 40)

        try:
            result = engine.process_sequential_thinking(test_case['params'])

            print(f'Thought: "{test_case["params"]["thought"]}"')
            print(f'Thought Number: {result["thoughtNumber"]}/{result["totalThoughts"]}')

            status = 'Continue' if result['nextThoughtNeeded'] else 'Complete'
            print(f'Status: {status}')
            print(f'Response Format: Minimal (token-efficient)\n')

        except Exception as error:
            print(f'‚ùå Error: {error}\n')

    print('‚úÖ All tests completed!')


def main():
    """Main CLI entry point"""
    args = sys.argv[1:]

    if len(args) == 0 or '-h' in args or '--help' in args:
        print_usage()
        return

    command = args[0]

    if command == 'interactive':
        print('Starting interactive mode...')
        from api import InteractiveMode
        engine = SequentialThinkingEngine()
        interactive = InteractiveMode(engine)
        interactive.start()

    elif command == 'api':
        # Read JSON from stdin and process
        try:
            input_data = sys.stdin.read()
            if not input_data.strip():
                raise ValueError('No input provided on stdin')

            engine = SequentialThinkingEngine()
            params = json.loads(input_data)

            result = engine.process_sequential_thinking(params)
            print(json.dumps(result, indent=2))

        except json.JSONDecodeError as error:
            raise ValueError(f'Invalid JSON: {error}')
        except Exception as error:
            raise error

    elif command == 'test':
        run_test()

    else:
        print(f'Unknown command: {command}', file=sys.stderr)
        print('Use "help" to see available commands', file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()