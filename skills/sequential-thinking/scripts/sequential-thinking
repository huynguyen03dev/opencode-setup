#!/usr/bin/env node

/**
 * Sequential Thinking CLI Wrapper
 * Provides a drop-in replacement for the MCP sequential-thinking tool
 */

const { SequentialThinkingEngine } = require('./api');
const fs = require('fs');
const path = require('path');

function printUsage() {
  console.log(`
Sequential Thinking CLI - Drop-in replacement for MCP sequential-thinking

Usage: node sequential-thinking <command>

Commands:
  interactive    Start interactive reasoning session
  api           API mode (JSON input/output)
  test          Run test examples

Examples:
  # Interactive mode
  node sequential-thinking interactive

  # API mode (compatible with original MCP tool)
  echo '{"thought":"Need to analyze the problem","thoughtNumber":1,"totalThoughts":5,"nextThoughtNeeded":true}' | node sequential-thinking api

  # Test with examples
  node sequential-thinking test
`);
}

function runTest() {
  const engine = new SequentialThinkingEngine();

  const testCases = [
    {
      name: 'Initial Thought',
      params: {
        thought: 'I need to analyze the database performance issue. The queries are running slowly.',
        thoughtNumber: 1,
        totalThoughts: 5,
        nextThoughtNeeded: true
      }
    },
    {
      name: 'Follow-up Thought',
      params: {
        thought: 'Let me examine the query execution plans to identify bottlenecks.',
        thoughtNumber: 2,
        totalThoughts: 5,
        nextThoughtNeeded: true
      }
    },
    {
      name: 'Revision Thought',
      params: {
        thought: 'After examining the execution plans, I found missing indexes are the primary cause.',
        thoughtNumber: 3,
        totalThoughts: 5,
        isRevision: true,
        revisesThought: 2,
        nextThoughtNeeded: true
      }
    },
    {
      name: 'Final Thought',
      params: {
        thought: 'The solution is to add composite indexes on frequently queried columns.',
        thoughtNumber: 4,
        totalThoughts: 4,
        nextThoughtNeeded: false
      }
    }
  ];

  console.log('ðŸ§ª Running Sequential Thinking Tests\n');

  testCases.forEach((testCase, index) => {
    console.log(`Test ${index + 1}: ${testCase.name}`);
    console.log('â”€'.repeat(40));

    try {
      const result = engine.processSequentialThinking(testCase.params);

      console.log(`Thought: "${testCase.params.thought}"`);
      console.log(`Analysis: ${result.analysis.type} (${result.analysis.complexity} complexity)`);
      console.log(`Confidence: ${(result.analysis.confidence * 100).toFixed(0)}%`);
      console.log(`Progress: ${(result.context.sessionProgress * 100).toFixed(0)}%`);

      if (result.recommendations.length > 0) {
        console.log(`Recommendation: ${result.recommendations[0]}`);
      }

      console.log(`Status: ${result.thoughtData.nextThoughtNeeded ? 'Continue' : 'Complete'}\n`);

    } catch (error) {
      console.error(`âŒ Error: ${error.message}\n`);
    }
  });

  console.log('âœ… All tests completed!');
}

function main() {
  const args = process.argv.slice(2);

  if (args.length === 0 || args.includes('-h') || args.includes('--help')) {
    printUsage();
    return;
  }

  const command = args[0];

  switch (command) {
    case 'interactive':
      console.log('Starting interactive mode...');
      require('./api');
      break;

    case 'api':
      // Read JSON from stdin and process
      let inputData = '';
      process.stdin.setEncoding('utf8');
      process.stdin.on('data', chunk => inputData += chunk);
      process.stdin.on('end', () => {
        try {
          const engine = new SequentialThinkingEngine();
          const params = JSON.parse(inputData);

          // Validate required parameters
          if (!params.thought || typeof params.nextThoughtNeeded !== 'boolean') {
            throw new Error('Missing required parameters: thought, nextThoughtNeeded');
          }

          const result = engine.processSequentialThinking(params);
          console.log(JSON.stringify(result, null, 2));

        } catch (error) {
          console.error(JSON.stringify({
            success: false,
            error: error.message,
            code: 'VALIDATION_ERROR'
          }, null, 2));
          process.exit(1);
        }
      });
      break;

    case 'test':
      runTest();
      break;

    default:
      console.error(`Unknown command: ${command}`);
      console.error('Use "help" to see available commands');
      process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = { main };